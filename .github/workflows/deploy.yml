name: Deploy to AWS EC2

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— í‘¸ì‹œí•  ë•Œ ìë™ ë°°í¬
  workflow_dispatch:  # ìˆ˜ë™ ë°°í¬ë„ ê°€ëŠ¥

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    name: Build and Deploy to EC2
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2. pnpm ì„¤ì •
      - name: ğŸ”§ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      # 3. Node.js ì„¤ì •
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: './server/pnpm-lock.yaml'

      # 4. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      # 5. ë¦°íŠ¸ & í…ŒìŠ¤íŠ¸ (ì„ íƒì‚¬í•­)
      - name: ğŸ§ª Run linter
        run: pnpm lint
        continue-on-error: true  # ë¦°íŠ¸ ì‹¤íŒ¨í•´ë„ ë°°í¬ ê³„ì†

      # 6. TypeScript ë¹Œë“œ
      - name: ğŸ”¨ Build TypeScript
        run: pnpm build

      # 7. í”„ë¡œë•ì…˜ ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜
      - name: ğŸ“¦ Install production dependencies
        run: |
          mkdir -p deploy
          cd deploy
          cp ../package.json ../pnpm-lock.yaml .
          pnpm install --prod --frozen-lockfile
          cd ..

      # 7. ë°°í¬ íŒŒì¼ ì¤€ë¹„
      - name: ğŸ“¦ Prepare deployment package
        run: |
          mkdir -p deploy_package
          cp -r dist deploy_package/
          cp -r deploy/node_modules deploy_package/
          cp package*.json deploy_package/
          cp -r scripts deploy_package/ 2>/dev/null || true

      # 8. rsync ì„¤ì¹˜
      - name: ğŸ“¦ Install rsync
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync

      # 9. SSH í‚¤ ì„¤ì •
      - name: ğŸ” Setup SSH key
        working-directory: ./
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # 10. EC2ë¡œ íŒŒì¼ ì „ì†¡
      - name: ğŸš€ Deploy to EC2
        working-directory: ./
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ec2-user
          APP_DIR: /home/ec2-user/app
        run: |
          # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
          ssh -i ~/.ssh/ec2_key.pem ${EC2_USER}@${EC2_HOST} "mkdir -p ${APP_DIR}"

          # íŒŒì¼ ì „ì†¡
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no" \
            server/deploy_package/ ${EC2_USER}@${EC2_HOST}:${APP_DIR}/

      # 11. í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (EC2ì—)
      - name: âš™ï¸  Setup environment variables
        working-directory: ./
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ec2-user
          APP_DIR: /home/ec2-user/app
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
          cd /home/ec2-user/app
          cat > .env.production << EOF
          NODE_ENV=production
          PORT=3000
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=7d
          AWS_REGION=ap-northeast-2
          BEDROCK_MODEL_ID=anthropic.claude-3-haiku-20240307
          BEDROCK_MAX_RETRIES=2
          BEDROCK_TIMEOUT=10000
          EOF
          ENDSSH

      # 12. PM2ë¡œ ì•± ì¬ì‹œì‘
      - name: ğŸ”„ Restart application with PM2
        working-directory: ./
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ec2-user
          APP_DIR: /home/ec2-user/app
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
          cd /home/ec2-user/app

          # PM2ê°€ ì—†ìœ¼ë©´ ì„¤ì¹˜
          if ! command -v pm2 &> /dev/null; then
            npm install -g pm2
          fi

          # .env.production íŒŒì¼ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ë¡œë“œ
          set -a
          source .env.production
          set +a

          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì‚­ì œ í›„ ì¬ì‹œì‘ (í™˜ê²½ ë³€ìˆ˜ í™•ì‹¤íˆ ë¡œë“œ)
          pm2 delete ibyeol-note 2>/dev/null || true
          pm2 start dist/main.js --name ibyeol-note -i 1
          pm2 save

          # ë¶€íŒ… ì‹œ ìë™ ì‹œì‘ ì„¤ì • (ì²˜ìŒ í•œ ë²ˆë§Œ í•„ìš”)
          pm2 startup systemd -u ec2-user --hp /home/ec2-user || true
          ENDSSH

      # 13. ë°°í¬ ì™„ë£Œ í™•ì¸
      - name: âœ… Verify deployment
        working-directory: ./
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ec2-user
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
          pm2 status
          pm2 logs ibyeol-note --lines 20 --nostream
          ENDSSH
